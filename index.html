<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EURO TOURS – Tour Serra da Estrela</title>

<link rel="icon" href="images/logo-euro-tours.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4;text-align:center;}
.topbar{background:white;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
.logo{height:60px;}
#map{height:45vh;width:100%;}
button{padding:14px 26px;margin:8px;font-size:16px;border:none;border-radius:8px;cursor:pointer;}
.btn-start{background:#2e7d32;color:white;}
.btn-stop{background:#c62828;color:white;}
#info{background:white;padding:15px;margin:10px;border-radius:8px;}
#debug{background:#111;color:#00ff88;padding:10px;font-size:12px;text-align:left;border-radius:8px;margin:10px;}
.galeria{position:relative;overflow:hidden;}
.carousel{display:flex;transition:transform .4s ease;}
.carousel img{min-width:100%;border-radius:8px;}
.car-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.6);color:white;border:none;padding:8px 12px;font-size:18px;z-index:5;}
.prev{left:5px;} .next{right:5px;}
</style>
</head>

<body>

<div class="topbar">
<img src="images/logo-euro-tours.png" class="logo">
</div>

<h2>Tour Interativo Serra da Estrela</h2>

<button class="btn-start" onclick="if(validarSenha()) iniciar()">INICIAR TOUR</button>
<button class="btn-stop" onclick="parar()">PARAR TOUR</button>

<div id="info"></div>
<div id="map"></div>
<div id="debug"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

// ================= MAPA =================
let map=L.map('map').setView([40.28,-7.50],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const userIcon=L.icon({
iconUrl:'images/logo-euro-tours.png',
iconSize:[40,40],
iconAnchor:[20,40]
});

// ================= ESTADO =================
let marcadorUsuario=null;
let ultimoPonto=null;
let pontoAtivoObj=null;
let watchId=null;
let audioAtual=null;
let pontosVisitados=new Set();
let linhaRota=L.polyline([], {color:'#1976d2',weight:4}).addTo(map);
const HISTERESIS=25;

// ================= SENHA =================
let acessoLiberado=false;

function gerarSenhaHoje(){
let hoje=new Date();
let ano=hoje.getFullYear();
let mes=String(hoje.getMonth()+1).padStart(2,'0');
let dia=String(hoje.getDate()).padStart(2,'0');
return "EURO-"+ano+mes+dia;
}

function validarSenha(){
if(acessoLiberado) return true;
let senha=prompt("Insira a senha fornecida pela EURO TOURS:");
if(senha && senha.trim().toUpperCase()===gerarSenhaHoje()){
acessoLiberado=true;
alert("Acesso autorizado. Bom tour!");
return true;
}else{
alert("Senha incorreta.");
return false;
}
}

// ================= PONTOS =================
const pontos = [
{
nome:"Central de Camionagem",
lat:40.2735,lng:-7.4983,raio:120,
texto:"Principal terminal rodoviário da Covilhã.",
img:["images/camionagem1.png"],
audio:"audio/camionagem.mp3"
},
{
nome:"Igreja Santa Maria Maior",
lat:40.280208,lng:-7.506062,raio:100,
texto:"Igreja Matriz da Covilhã.",
img:[
"images/santa-maria.jpg",
"images/santa-maria2.jpg",
"images/santa-maria3.jpg",
"images/santa-maria4.jpg",
"images/santa-maria5.jpg"
],
audio:"audio/santamaria.mp3"
},
{
nome:"Penhas da Saúde",
lat:40.3076,lng:-7.5486,raio:700,
texto:"Importante estância turística.",
img:[
"images/penhas1.jpg",
"images/penhas2.png",
"images/penhas3.png"
],
audio:"audio/penhas.mp3"
},
{
nome:"Edifício Teleférico Piornos",
lat:40.314362,lng:-7.575729,raio:700,
texto:"Zona de acesso às áreas altas.",
img:[
"images/teleferico1.png",
"images/teleferico2.png",
"images/teleferico3.png",
"images/teleferico4.png",
"images/teleferico5.png",
"images/teleferico6.png"
],
audio:"audio/teleferico.mp3"
}
];

// Marcadores fixos
pontos.forEach(p=>{
L.marker([p.lat,p.lng]).addTo(map).bindPopup(p.nome);
L.circle([p.lat,p.lng],{radius:p.raio,color:"#0077ff",fillOpacity:0.08}).addTo(map);
});

// ================= CONTROLO =================
function iniciar(){
if(watchId!==null) return;
watchId=navigator.geolocation.watchPosition(atualizar,erro,{enableHighAccuracy:true});
}

function parar(){
if(watchId!==null){navigator.geolocation.clearWatch(watchId);watchId=null;}
if(audioAtual) audioAtual.pause();
}

// ================= ATUALIZAÇÃO =================
function atualizar(pos){

let lat=pos.coords.latitude;
let lng=pos.coords.longitude;
let precisao=pos.coords.accuracy;

if(!marcadorUsuario){
marcadorUsuario=L.marker([lat,lng],{icon:userIcon}).addTo(map);
}else{
marcadorUsuario.setLatLng([lat,lng]);
}

linhaRota.addLatLng([lat,lng]);

let maisProximo=null;
let menorDist=Infinity;

pontos.forEach(p=>{
let d=dist(lat,lng,p.lat,p.lng);
if(d<p.raio && d<menorDist){
maisProximo=p;
menorDist=d;
}
});

if(pontoAtivoObj){
let dAtual=dist(lat,lng,pontoAtivoObj.lat,pontoAtivoObj.lng);
if(dAtual<=pontoAtivoObj.raio+HISTERESIS){
maisProximo=pontoAtivoObj;
}
}

if(maisProximo && maisProximo.nome!==ultimoPonto){
ultimoPonto=maisProximo.nome;
pontoAtivoObj=maisProximo;
pontosVisitados.add(maisProximo.nome);
map.flyTo([maisProximo.lat,maisProximo.lng],15);
mostrarInfo(maisProximo);
tocarAudio(maisProximo);
vibrar();
}

document.getElementById("debug").innerHTML=
"Lat: "+lat+"<br>"+
"Lng: "+lng+"<br>"+
"Precisão: "+Math.round(precisao)+"m<br>"+
"Ponto ativo: "+(ultimoPonto||"Nenhum")+"<br>"+
"Pontos visitados: "+pontosVisitados.size+" / "+pontos.length;
}

// ================= INFO =================
function mostrarInfo(p){
let html="<h3>"+p.nome+"</h3><p>"+p.texto+"</p>";
if(p.img && p.img.length){
let id="car_"+Date.now();
html+=`<div class="galeria">
<button class="car-btn prev" onclick="mover('${id}',-1)">‹</button>
<div class="carousel" id="${id}">`;
p.img.forEach(f=>{html+=`<img src="${f}">`;});
html+=`</div>
<button class="car-btn next" onclick="mover('${id}',1)">›</button>
</div>`;
}
document.getElementById("info").innerHTML=html;
}

const carIndex={};
function mover(id,dir){
const el=document.getElementById(id);
if(!el) return;
const total=el.children.length;
if(!(id in carIndex)) carIndex[id]=0;
carIndex[id]+=dir;
if(carIndex[id]<0) carIndex[id]=total-1;
if(carIndex[id]>=total) carIndex[id]=0;
el.style.transform=`translateX(-${carIndex[id]*100}%)`;
}

function tocarAudio(p){
if(!p.audio) return;
if(audioAtual) audioAtual.pause();
audioAtual=new Audio(p.audio);
audioAtual.play().catch(()=>{});
}

function vibrar(){
if(navigator.vibrate) navigator.vibrate([200,100,200]);
}

function dist(lat1,lon1,lat2,lon2){
const R=6371000;
const dLat=(lat2-lat1)*Math.PI/180;
const dLon=(lon2-lon1)*Math.PI/180;
const a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function erro(){
document.getElementById("debug").innerHTML="Erro ao obter GPS";
}

</script>
</body>
</html>
