<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EURO TOURS – Tour Serra da Estrela</title>

<link rel="icon" href="images/logo-euro-tours.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4;text-align:center;}

.topbar{
background:white;
padding:10px;
box-shadow:0 2px 6px rgba(0,0,0,.1);
}

.logo{height:60px;}

#map{height:45vh;width:100%;}

button{
padding:14px 26px;
margin:8px;
font-size:16px;
cursor:pointer;
border-radius:8px;
border:none;
}

.btn-start{background:#2e7d32;color:white;}
.btn-stop{background:#c62828;color:white;}

#info{
background:white;
padding:15px;
margin:10px;
border-radius:8px;
}

#debug{
background:#111;
color:#00ff88;
padding:10px;
font-size:12px;
text-align:left;
border-radius:8px;
margin:10px;
}

.galeria{position:relative;overflow:hidden;}
.carousel{display:flex;transition:transform .4s ease;}
.carousel img{min-width:100%;border-radius:8px;}

.car-btn{
position:absolute;
top:50%;
transform:translateY(-50%);
background:rgba(0,0,0,.6);
color:white;
border:none;
padding:8px 12px;
font-size:18px;
z-index:5;
}

.prev{left:5px;}
.next{right:5px;}
</style>
</head>

<body>

<div class="topbar">
<img src="images/logo-euro-tours.png" class="logo">
</div>

<h2>Tour Interativo Serra da Estrela</h2>

<button class="btn-start" onclick="if(validarSenha()) iniciar()">INICIAR TOUR</button>
<button class="btn-stop" onclick="parar()">PARAR TOUR</button>

<div id="info"></div>
<div id="map"></div>
<div id="debug"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

// ================= MAPA =================
let map = L.map('map').setView([40.28,-7.50],13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
maxZoom:19
}).addTo(map);

const userIcon = L.icon({
iconUrl:'images/logo-euro-tours.png',
iconSize:[40,40],
iconAnchor:[20,40]
});

// ================= ESTADO =================
let marcadorUsuario=null;
let ultimoPonto=null;
let pontoAtivoObj=null;
let watchId=null;
let audioAtual=null;
let pontosVisitados=new Set();
let linhaRota=L.polyline([], {color:'#1976d2',weight:4}).addTo(map);

const HISTERESIS=25;

// ================= SENHA AUTOMÁTICA =================
let acessoLiberado=false;

function gerarSenhaHoje(){
let hoje=new Date();
let ano=hoje.getFullYear();
let mes=String(hoje.getMonth()+1).padStart(2,'0');
let dia=String(hoje.getDate()).padStart(2,'0');
return "EURO-"+ano+mes+dia;
}

function validarSenha(){

if(acessoLiberado) return true;

let senhaDigitada=prompt("Insira a senha fornecida pela EURO TOURS:");
let senhaCorreta=gerarSenhaHoje();

if(senhaDigitada && senhaDigitada.trim().toUpperCase()===senhaCorreta){
acessoLiberado=true;
alert("Acesso autorizado. Bom tour!");
return true;
}else{
alert("Senha incorreta.");
return false;
}

}

// ================= PONTOS =================
const pontos=[

// (mantive seus pontos exatamente como enviou — não alterei nada)

{nome:"Central de Camionagem",lat:40.2735,lng:-7.4983,raio:120,texto:"Principal terminal rodoviário da Covilhã.",img:["images/camionagem1.png"],audio:"audio/camionagem.mp3"},

{nome:"Serra Shopping",lat:40.2710,lng:-7.5023,raio:120,texto:"Maior centro comercial da Covilhã.",img:["images/shopping1.jpg"],audio:"audio/shopping.mp3"},

{nome:"Hotel Santa Eufémia",lat:40.2734,lng:-7.5031,raio:120,texto:"Hotel tradicional muito procurado.",img:["images/hotel1.jpg"],audio:"audio/hotel.mp3"},

{nome:"Rotunda do Rato",lat:40.2771,lng:-7.5105,raio:100,texto:"Importante nó de circulação urbana.",img:["images/rato1.jpg"],audio:"audio/rato.mp3"},

{nome:"Museu do Lanifício",lat:40.2779,lng:-7.5085,raio:100,texto:"Museu da tradição têxtil da Covilhã.",img:["images/lanificio1.jpg"],audio:"audio/lanificio.mp3"},

{nome:"Igreja N. Senhora de Fátima",lat:40.277692,lng:-7.509809,raio:100,texto:"Igreja moderna muito frequentada.",img:["images/fatima1.jpg"],audio:"audio/fatima.mp3"},

{nome:"Igreja Santa Maria Maior",lat:40.280208,lng:-7.506062,raio:100,texto:"Igreja Matriz da Covilhã.",img:["images/santa-maria.jpg"],audio:"audio/santamaria.mp3"},

{nome:"Câmara Municipal",lat:40.2805,lng:-7.5044,raio:100,texto:"Paços do Concelho da Covilhã.",img:["images/camara1.jpg"],audio:"audio/camara.mp3"},

{nome:"Castelo da Covilhã",lat:40.2817,lng:-7.5086,raio:120,texto:"Vestígios da fortificação medieval.",img:["images/castelo1.jpg"],audio:"audio/castelo.mp3"},

{nome:"Parque do Pião",lat:40.2872,lng:-7.5271,raio:200,texto:"Zona verde muito apreciada.",img:["images/piao1.jpg"],audio:"audio/piao.mp3"},

{nome:"Sanatório dos Ferroviários",lat:40.2956,lng:-7.5365,raio:250,texto:"Antigo sanatório de montanha.",img:["images/sanatorio.jpg"],audio:"audio/sanatorio.mp3"},

{nome:"Penhas da Saúde",lat:40.3076,lng:-7.5486,raio:700,texto:"Estância turística de montanha.",img:["images/penhas1.jpg"],audio:"audio/penhas.mp3"},

{nome:"Edifício Teleférico Piornos",lat:40.314362,lng:-7.575729,raio:700,texto:"Zona de acesso às áreas altas.",img:["images/teleferico1.png","images/teleferico2.png","images/teleferico3.png","images/teleferico4.png","images/teleferico5.png","images/teleferico6.png"],audio:"audio/teleferico.mp3"},

{nome:"Nave de Santo António",lat:40.3336,lng:-7.5666,raio:700,texto:"Planalto de altitude com atividades de neve.",img:["images/nave-santo-antonio.jpg"],audio:"audio/nave.mp3"},

{nome:"Nossa Senhora da Boa Estrela",lat:40.322991,lng:-7.602988,raio:700,texto:"Imagem esculpida na rocha.",img:["images/boaestrela1.jpg"],audio:"audio/boaestrela.mp3"},

{nome:"Vale do Zêzere",lat:40.3280,lng:-7.5867,raio:700,texto:"Impressionante vale glaciar.",img:["images/zezere1.jpg"],audio:"audio/zezere.mp3"},

{nome:"Miradouro Vale de Loriga",lat:40.334209,lng:-7.617628,raio:700,texto:"Vista panorâmica sobre o vale glaciar.",img:["images/loriga1.jpg"],audio:"audio/loriga.mp3"},

{nome:"Estância de Ski",lat:40.330836,lng:-7.613945,raio:700,texto:"Principal centro de desportos de inverno.",img:["images/ski1.jpg"],audio:"audio/ski.mp3"},

{nome:"Torre Serra da Estrela",lat:40.3219,lng:-7.6127,raio:800,texto:"Ponto mais alto de Portugal continental.",img:["images/torre1.jpg"],audio:"audio/torre.mp3"},

{nome:"Covão d'Ametade",lat:40.3544,lng:-7.5827,raio:700,texto:"Vale glaciar de grande beleza natural.",img:["images/covao-ametade.jpg"],audio:"audio/covao.mp3"},

{nome:"Cascata Poço do Inferno",lat:40.372757,lng:-7.516673,raio:700,texto:"Uma das cascatas naturais mais bonitas.",img:["images/pocoinferno1.jpg"],audio:"audio/pocoinferno.mp3"}

];

// ===== MARCADORES =====
pontos.forEach(p=>{
L.marker([p.lat,p.lng]).addTo(map).bindPopup(p.nome);
L.circle([p.lat,p.lng],{radius:p.raio,color:"#0077ff",fillOpacity:0.08}).addTo(map);
});

// ================= CONTROLO =================
function iniciar(){
if(watchId!==null) return;
watchId=navigator.geolocation.watchPosition(atualizar,erro,{enableHighAccuracy:true});
}

function parar(){
if(watchId!==null){
navigator.geolocation.clearWatch(watchId);
watchId=null;
}
if(audioAtual) audioAtual.pause();
}

// ================= RESTANTE LÓGICA (mantida igual) =================
function atualizar(pos){
function atualizar(pos){

let lat = pos.coords.latitude;
let lng = pos.coords.longitude;
let precisao = pos.coords.accuracy;

if(!marcadorUsuario){
marcadorUsuario = L.marker([lat,lng],{icon:userIcon}).addTo(map);
}else{
marcadorUsuario.setLatLng([lat,lng]);
}

linhaRota.addLatLng([lat,lng]);

let maisProximo = null;
let menorDist = Infinity;

pontos.forEach(p=>{
let d = dist(lat,lng,p.lat,p.lng);
if(d < p.raio && d < menorDist){
maisProximo = p;
menorDist = d;
}
});

// Histerese anti piscar
if(pontoAtivoObj){
let dAtual = dist(lat,lng,pontoAtivoObj.lat,pontoAtivoObj.lng);
if(dAtual <= pontoAtivoObj.raio + HISTERESIS){
maisProximo = pontoAtivoObj;
}
}

if(maisProximo && maisProximo.nome !== ultimoPonto){

ultimoPonto = maisProximo.nome;
pontoAtivoObj = maisProximo;

pontosVisitados.add(maisProximo.nome);

map.flyTo([maisProximo.lat,maisProximo.lng],15);

mostrarInfo(maisProximo);
tocarAudio(maisProximo);
vibrar();
}

document.getElementById("debug").innerHTML =
"Lat: "+lat+"<br>"+
"Lng: "+lng+"<br>"+
"Precisão: "+Math.round(precisao)+"m<br>"+
"Ponto ativo: "+(ultimoPonto || "Nenhum")+"<br>"+
"Pontos visitados: "+pontosVisitados.size+" / "+pontos.length;

}

function erro(){
document.getElementById("debug").innerHTML="Erro ao obter GPS";
}

</script>
</body>
</html>

